<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage {{ company.name }} | Barter</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
    <!-- HEADER -->
    <header class="header">
        <div class="logo">www.barter.com</div>
        <nav class="nav">
            <a href="{{ url_for('main.index') }}">Dashboard</a>
            <a href="{{ url_for('main.my_companies') }}">My Companies</a>
        </nav>
    </header>

    <section class="content-container">
        <div class="content-card">
            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                {% for category, msg in messages %}
                  <div class="alert alert-{{ category }}">{{ msg }}</div>
                {% endfor %}
              {% endif %}
            {% endwith %}
            <h1>Manage {{ company.name }}</h1>

            <div class="info-section">
                <h3>Company Info</h3>
                <div class="code-display">Join Code: {{ company.join_code or 'No code' }}</div>
                <div style="margin-top: 8px;"><strong>Barter Coins:</strong> {{ company.barter_coins }}</div>
                <div style="margin-top: 12px;">
                    <a href="{{ url_for('main.company_deals', company_id=company.company_id) }}" class="btn-outline small">View Active Deals</a>
                </div>
            </div>

            <!-- MUTUAL INTERESTS -->
            {% if mutual_interests %}
            <div class="company-section" style="background: #e8f5e9; padding: 20px; border-radius: 8px; margin-bottom: 24px;">
                <h3 style="color: #2e7d32; margin-top: 0;">ü§ù Mutual Interests - Send Proposals</h3>
                <p style="color: #666; margin-bottom: 16px;">These companies are interested in your services, and you're interested in theirs!</p>
                {% for mi in mutual_interests %}
                    <div class="content-card" style="margin-bottom: 16px; padding: 16px;">
                        <h4 style="color: var(--blue); margin-top: 0;">{{ mi.other_company.name }}</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 12px;">
                            <div>
                                <strong>Your Service:</strong><br>
                                {{ mi.my_service.title }}
                            </div>
                            <div>
                                <strong>Their Service:</strong><br>
                                {{ mi.other_service.title }}
                            </div>
                        </div>
                        <form method="post" action="{{ url_for('main.send_proposal') }}" style="display: flex; gap: 12px; align-items: end; flex-wrap: wrap;">
                            <input type="hidden" name="from_company_id" value="{{ company.company_id }}">
                            <input type="hidden" name="to_company_id" value="{{ mi.other_company.company_id }}">
                            <input type="hidden" name="from_service_id" value="{{ mi.my_service.service_id }}">
                            <input type="hidden" name="to_service_id" value="{{ mi.other_service.service_id }}">
                            <div>
                                <label for="coins_{{ loop.index }}" style="font-size: 13px;">Barter Coins (optional):</label>
                                <input type="number" id="coins_{{ loop.index }}" name="barter_coins" min="0" max="{{ company.barter_coins }}" value="0" style="width: 100px; padding: 6px;">
                            </div>
                            <div style="flex: 1; min-width: 200px;">
                                <label for="msg_{{ loop.index }}" style="font-size: 13px;">Message (optional):</label>
                                <input type="text" id="msg_{{ loop.index }}" name="message" placeholder="Add a message..." style="width: 100%; padding: 6px;">
                            </div>
                            <button type="submit" class="btn-primary small">Send Proposal</button>
                        </form>
                    </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- INCOMING PROPOSALS -->
            {% if incoming_proposals %}
            <div class="company-section" style="background: #fff3e0; padding: 20px; border-radius: 8px; margin-bottom: 24px;">
                <h3 style="color: #e65100; margin-top: 0;">üì¨ Incoming Proposals</h3>
                {% for prop in incoming_proposals %}
                    <div class="content-card" style="margin-bottom: 16px; padding: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <h4 style="color: var(--blue); margin: 0;">From: {{ prop.from_company.name }}</h4>
                            <span style="background: #ffa500; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">Pending</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 12px;">
                            <div>
                                <strong>They offer:</strong><br>
                                {{ prop.from_service.title }}
                            </div>
                            <div>
                                <strong>They want:</strong><br>
                                {{ prop.to_service.title }}
                            </div>
                        </div>
                        {% if prop.barter_coins_offered > 0 %}
                            <div style="margin-bottom: 12px;">
                                <strong>Barter Coins Offered:</strong> {{ prop.barter_coins_offered }}
                            </div>
                        {% endif %}
                        {% if prop.message %}
                            <div style="margin-bottom: 12px; padding: 12px; background: #f5f5f5; border-radius: 4px;">
                                <strong>Message:</strong> {{ prop.message }}
                            </div>
                        {% endif %}
                        <div style="display: flex; gap: 8px;">
                            <form method="post" action="{{ url_for('main.accept_proposal', proposal_id=prop.proposal_id) }}" style="display: inline;">
                                <button type="submit" class="btn-success small">Accept</button>
                            </form>
                            <form method="post" action="{{ url_for('main.reject_proposal', proposal_id=prop.proposal_id) }}" style="display: inline;">
                                <button type="submit" class="btn-danger small">Reject</button>
                            </form>
                        </div>
                    </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- SENT PROPOSALS -->
            {% if sent_proposals %}
            <div class="company-section" style="margin-bottom: 24px;">
                <h3>üì§ Sent Proposals</h3>
                {% for prop in sent_proposals %}
                    <div class="content-card" style="margin-bottom: 12px; padding: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                            <div style="flex: 1;">
                                <strong>To:</strong> {{ prop.to_company.name }}<br>
                                <span style="font-size: 13px; color: var(--gray);">
                                    {{ prop.from_service.title }} ‚áÑ {{ prop.to_service.title }}
                                </span>
                            </div>
                            <div>
                                <strong>Status:</strong> 
                                <span style="color: {% if prop.status == 'accepted' %}green{% elif prop.status == 'rejected' %}red{% else %}orange{% endif %}; font-weight: 500;">
                                    {% if prop.status == 'accepted' %}‚úì Accepted
                                    {% elif prop.status == 'rejected' %}‚úó Rejected
                                    {% else %}‚è≥ Pending
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            {% endif %}

            <div class="company-section">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>Pending Join Requests</h3>
                    <form method="post" action="{{ url_for('main.delete_company', company_id=company.company_id) }}" onsubmit="return confirm('Are you sure you want to delete this company? This will remove all members and pending requests.');" style="display:inline;">
                        <button type="submit" class="btn-danger small">Delete Company</button>
                    </form>
                </div>
                {% if pending %}
                    {% for r in pending %}
                        <div class="member-item">
                            <div class="member-name">{{ r.user.username if r.user else r.user_id }}</div>
                            <form method="post" action="{{ url_for('main.accept_join_request', company_id=company.company_id, request_id=r.request_id) }}" style="display:inline;">
                                <button type="submit" class="btn-primary small">Accept</button>
                            </form>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="empty-state">No pending requests</p>
                {% endif %}
            </div>

            <div class="company-section">
                <h3>Company Members</h3>
                {% for m in members %}
                    <div class="member-item">
                        <div>
                            <div class="member-name">{{ m.user_obj.username if m.user_obj else m.user_id }}</div>
                            <div class="member-role">{{ 'Admin' if m.is_admin else 'Member' }}</div>
                        </div>
                        <div style="display:flex; gap:8px;">
                            {% if (not m.is_admin) and not (m.user_id == (session['user_id'] | string)) %}
                                <form method="post" action="{{ url_for('main.remove_member', company_id=company.company_id, member_id=m.member_id) }}" onsubmit="return confirm('Remove this member?');" style="display:inline;">
                                    <button type="submit" class="btn-danger small">Remove</button>
                                </form>
                                <form method="post" action="{{ url_for('main.transfer_admin', company_id=company.company_id, member_id=m.member_id) }}" onsubmit="return confirm('Are you sure you want to transfer admin rights to this user? You will no longer be admin.');" style="display:inline;">
                                    <button type="submit" class="btn-success small">Promote to Admin</button>
                                </form>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>

            <div class="form-links">
                <a href="{{ url_for('main.my_companies') }}">Back to My Companies</a>
            </div>
        </div>
    </section>

    <footer class="footer">
        ¬© 2025 Barter.com. Building partnerships through service exchange.
    </footer>
</body>
</html>
