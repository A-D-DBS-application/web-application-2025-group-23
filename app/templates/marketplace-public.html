{% extends "base.html" %}
{% block title %}Marketplace | Barter.com{% endblock %}
{% block nav_marketplace_active %}class="active"{% endblock %}

{% block content %}
    <link rel="stylesheet" href="{{ url_for('static', filename='tradeflow.css') }}">
    
    <div class="tradeflow-container">
        <!-- Main Content - Full Width -->
        <main class="main" style="margin-left: 0; width: 100%; max-width: 1400px; margin: 0 auto; padding: 32px;">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Marketplace</h1>
                    <p class="page-desc">Browse available services - Login to request trades</p>
                </div>
            </div>

            <div class="login-notice" style="margin-bottom: 32px; padding: 16px 20px; background: #e8f0fe; border: 1px solid #d2e3fc; border-radius: 8px;">
                <div class="notice-content" style="display: flex; align-items: center; gap: 12px;">
                    {% if is_logged_in %}
                    <span class="notice-text" style="color: #1967d2; font-size: 14px;">You need to be part of a company to show interest in services. <a href="{{ url_for('main.create_company') }}" style="font-weight: 600; text-decoration: underline; color: #1967d2;">Create</a> or <a href="{{ url_for('main.join_company') }}" style="font-weight: 600; text-decoration: underline; color: #1967d2;">join</a> a company to get started!</span>
                    {% else %}
                    <span class="notice-text" style="color: #1967d2; font-size: 14px;">Want to trade services? <a href="{{ url_for('main.login') }}" style="font-weight: 600; text-decoration: underline; color: #1967d2;">Login</a> or <a href="{{ url_for('main.register') }}" style="font-weight: 600; text-decoration: underline; color: #1967d2;">Register</a> to get started!</span>
                    {% endif %}
                </div>
            </div>

            <div style="margin-bottom: 32px;">
                <form method="get" style="display: flex; gap: 12px;">
                    <input type="text" name="search" placeholder="Search services..." class="form-input" value="{{ search_query or '' }}" style="flex: 1;">
                    <select name="category" class="form-input" onchange="this.form.submit()" style="width: auto; min-width: 200px;">
                        <option value="">All Categories</option>
                        <option value="Marketing" {% if category_filter == 'Marketing' %}selected{% endif %}>Marketing</option>
                        <option value="Development" {% if category_filter == 'Development' %}selected{% endif %}>Development</option>
                        <option value="Writing" {% if category_filter == 'Writing' %}selected{% endif %}>Writing</option>
                        <option value="Design" {% if category_filter == 'Design' %}selected{% endif %}>Design</option>
                        <option value="Finance" {% if category_filter == 'Finance' %}selected{% endif %}>Finance</option>
                        <option value="Accounting" {% if category_filter == 'Accounting' %}selected{% endif %}>Accounting</option>
                        <option value="IT" {% if category_filter == 'IT' %}selected{% endif %}>IT</option>
                        <option value="Legal" {% if category_filter == 'Legal' %}selected{% endif %}>Legal</option>
                        <option value="Consulting" {% if category_filter == 'Consulting' %}selected{% endif %}>Consulting</option>
                        <option value="Sales" {% if category_filter == 'Sales' %}selected{% endif %}>Sales</option>
                        <option value="HR" {% if category_filter == 'HR' %}selected{% endif %}>HR</option>
                        <option value="Operations" {% if category_filter == 'Operations' %}selected{% endif %}>Operations</option>
                        <option value="Customer Support" {% if category_filter == 'Customer Support' %}selected{% endif %}>Customer Support</option>
                    </select>
                    <button type="submit" class="btn-primary">Search</button>
                </form>
            </div>

            <div class="cards-grid" style="grid-template-columns: repeat(4, 1fr);">
                {% for service in services %}
                <div class="card" style="cursor: pointer;" onclick="window.location.href='{{ url_for('main.marketplace_service_detail_view', service_id=service.service_id) }}'">
                    <div class="card-company">{{ service.company.name }}</div>
                    <div class="card-title">{{ service.title }}</div>
                    <div class="card-desc">{{ service.description[:120] }}{% if service.description|length > 120 %}...{% endif %}</div>
                    
                    {% if service.categories %}
                    <div class="card-categories">
                        {% for cat in service.categories.split(',') %}
                        <span class="card-category-tag">{{ cat.strip() }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <div class="card-meta">
                        <span>{{ service.duration_hours }} hours</span>
                        {% set rating_key = service.service_id|string %}
                        {% if rating_key in service_ratings %}
                        <span style="color: #fbbc04;">‚òÖ {{ "%.1f"|format(service_ratings[rating_key].avg) }} ({{ service_ratings[rating_key].count }})</span>
                        {% endif %}
                    </div>
                    
                    <button class="card-button">View Service</button>
                </div>
                {% else %}
                <div class="empty">
                    <div class="empty-icon">üîç</div>
                    <div class="empty-text">No services available in the marketplace yet.</div>
                </div>
                {% endfor %}
            </div>

            {% if pagination and pagination.pages > 1 %}
            <div style="margin-top: 32px; display: flex; align-items: center; gap: 16px; justify-content: center;">
                {% if pagination.has_prev %}
                    <a href="{{ url_for('main.marketplace_public', page=pagination.prev_num, search=search_query, category=category_filter) }}" class="btn-secondary">&larr; Previous</a>
                {% else %}
                    <button class="btn-secondary" disabled style="opacity: 0.5; cursor: not-allowed;">&larr; Previous</button>
                {% endif %}

                <span style="font-size: 14px; color: #5f6368;">Page {{ pagination.page }} of {{ pagination.pages }}</span>

                {% if pagination.has_next %}
                    <a href="{{ url_for('main.marketplace_public', page=pagination.next_num, search=search_query, category=category_filter) }}" class="btn-secondary">Next &rarr;</a>
                {% else %}
                    <button class="btn-secondary" disabled style="opacity: 0.5; cursor: not-allowed;">Next &rarr;</button>
                {% endif %}
            </div>
            {% endif %}
        </main>
    </div>
{% endblock %}
