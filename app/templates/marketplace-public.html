{% extends "base.html" %}
{% block title %}Marketplace | Barter.com{% endblock %}
{% block nav_marketplace_active %}class="active"{% endblock %}

{% block content %}
    <link rel="stylesheet" href="{{ url_for('static', filename='marketplace-public.css') }}">
    
    <div class="marketplace-container">
        <!-- Main Content - Full Width -->
        <div class="marketplace-header">
            <h1>Marketplace</h1>
            <p class="header-subtitle">Browse available services - Login to request trades</p>
        </div>

        <div class="login-notice">
            <div class="notice-content">
                {% if is_logged_in %}
                <span class="notice-text">You need to be part of a company to show interest in services. <a href="{{ url_for('main.create_company') }}">Create</a> or <a href="{{ url_for('main.join_company') }}">join</a> a company to get started!</span>
                {% else %}
                <span class="notice-text">Want to trade services? <a href="{{ url_for('main.login') }}">Login</a> or <a href="{{ url_for('main.register') }}">Register</a> to get started!</span>
                {% endif %}
            </div>
        </div>

        <form method="get" class="filters">
            <input type="text" name="search" placeholder="Search services..." class="search-bar" value="{{ search_query or '' }}">
            <select name="category" class="category-filter" onchange="this.form.submit()">
                <option value="">All Categories</option>
                <option value="Marketing" {% if category_filter == 'Marketing' %}selected{% endif %}>Marketing</option>
                <option value="Development" {% if category_filter == 'Development' %}selected{% endif %}>Development</option>
                <option value="Writing" {% if category_filter == 'Writing' %}selected{% endif %}>Writing</option>
                <option value="Design" {% if category_filter == 'Design' %}selected{% endif %}>Design</option>
                <option value="Finance" {% if category_filter == 'Finance' %}selected{% endif %}>Finance</option>
                <option value="Accounting" {% if category_filter == 'Accounting' %}selected{% endif %}>Accounting</option>
                <option value="IT" {% if category_filter == 'IT' %}selected{% endif %}>IT</option>
                <option value="Legal" {% if category_filter == 'Legal' %}selected{% endif %}>Legal</option>
                <option value="Consulting" {% if category_filter == 'Consulting' %}selected{% endif %}>Consulting</option>
                <option value="Sales" {% if category_filter == 'Sales' %}selected{% endif %}>Sales</option>
                <option value="HR" {% if category_filter == 'HR' %}selected{% endif %}>HR</option>
                <option value="Operations" {% if category_filter == 'Operations' %}selected{% endif %}>Operations</option>
                <option value="Customer Support" {% if category_filter == 'Customer Support' %}selected{% endif %}>Customer Support</option>
            </select>
            <button type="submit" class="btn-primary">Search</button>
        </form>

        <div class="services-grid">
            {% for service in services %}
            <div class="service-card" onclick="window.location.href='{{ url_for('main.marketplace_service_detail_view', service_id=service.service_id) }}'">
                <div class="service-company">{{ service.company.name }}</div>
                <h3 class="service-title">{{ service.title }}</h3>
                <p class="service-desc">{{ service.description[:120] }}{% if service.description|length > 120 %}...{% endif %}</p>
                
                {% if service.categories %}
                <div class="service-categories">
                    {% for cat in service.categories.split(',') %}
                    <span class="category-tag">{{ cat.strip() }}</span>
                    {% endfor %}
                </div>
                {% endif %}
                
                <div class="service-meta">
                    <span>{{ service.duration_hours }} hours</span>
                    {% set rating_key = service.service_id|string %}
                    {% if rating_key in service_ratings %}
                    <span class="service-rating">‚òÖ {{ "%.1f"|format(service_ratings[rating_key].avg) }} ({{ service_ratings[rating_key].count }})</span>
                    {% endif %}
                </div>
                
                <button class="view-button">View Service</button>
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-icon">üîç</div>
                <div class="empty-text">No services available in the marketplace yet.</div>
            </div>
            {% endfor %}
        </div>

        {% if pagination and pagination.pages > 1 %}
        <div class="pagination">
            {% if pagination.has_prev %}
                <a href="{{ url_for('main.marketplace_public', page=pagination.prev_num, search=search_query, category=category_filter) }}" class="pagination-btn">&larr; Previous</a>
            {% else %}
                <button class="pagination-btn disabled" disabled>&larr; Previous</button>
            {% endif %}

            <span class="pagination-info">Page {{ pagination.page }} of {{ pagination.pages }}</span>

            {% if pagination.has_next %}
                <a href="{{ url_for('main.marketplace_public', page=pagination.next_num, search=search_query, category=category_filter) }}" class="pagination-btn">Next &rarr;</a>
            {% else %}
                <button class="pagination-btn disabled" disabled>Next &rarr;</button>
            {% endif %}
        </div>
        {% endif %}
    </div>
{% endblock %}
