{# Tradeflow sidebar partial - include met: {% include '_tradeflow_sidebar.html' %} #}
{# Vereist variabelen: company, unread_counts, active_page #}

<aside class="sidebar tradeflow-sidebar">
  <div class="tradeflow-sidebar-header">
    <div class="tradeflow-sidebar-company">
      <div class="tradeflow-sidebar-company-label">Company</div>
      <p class="sidebar-helper">Select the company for which you want to view the trade flow.</p>
      <div class="tradeflow-sidebar-company-dropdown">
        <button type="button" class="tradeflow-sidebar-company-select" id="company-select-btn" aria-expanded="false" aria-haspopup="true">
          <div class="tradeflow-sidebar-company-select-text">
            <span class="tradeflow-sidebar-company-select-prefix">Trading as:</span>
            <span class="tradeflow-sidebar-company-select-name">{{ company.name }}</span>
          </div>
          <span class="tradeflow-sidebar-company-select-chevron">▾</span>
        </button>
        {% if user_companies and user_companies|length > 1 %}
        <div class="tradeflow-sidebar-company-dropdown-menu" id="company-dropdown-menu" role="menu">
          {% for comp in user_companies %}
          <a href="{{ url_for('main.tradeflow_switch_company', new_company_id=comp.company_id) }}" 
             class="tradeflow-sidebar-company-dropdown-item {% if comp.is_selected %}active{% endif %}" 
             role="menuitem">
            <span class="company-dropdown-name">{{ comp.name }}</span>
            {% if comp.is_selected %}<span class="company-dropdown-check">✓</span>{% endif %}
          </a>
          {% endfor %}
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="sidebar-section">
    <div class="sidebar-section-title">Requests</div>
    <a href="{{ url_for('main.tradeflow_incoming_requests', company_id=company.company_id) }}"
       class="sidebar-link {% if active_page == 'incoming' %}active{% endif %}">
      <span>Incoming requests</span>
      {% if unread_counts and unread_counts.incoming > 0 %}<span class="notification-badge">{{ unread_counts.incoming }}</span>{% endif %}
    </a>
    <a href="{{ url_for('main.tradeflow_you_requested', company_id=company.company_id) }}"
       class="sidebar-link {% if active_page == 'you_requested' %}active{% endif %}">
      <span>You requested</span>
      {% if unread_counts and unread_counts.you_requested > 0 %}<span class="notification-badge">{{ unread_counts.you_requested }}</span>{% endif %}
    </a>
    <a href="{{ url_for('main.tradeflow_archived_requests', company_id=company.company_id) }}"
       class="sidebar-link {% if active_page == 'archived' %}active{% endif %}">
      <span>Archived requests</span>
      {% if unread_counts and unread_counts.archived > 0 %}<span class="notification-badge">{{ unread_counts.archived }}</span>{% endif %}
    </a>
  </div>

  <div class="sidebar-section">
    <div class="sidebar-section-title">Contracts</div>
    <a href="{{ url_for('main.tradeflow_match_made', company_id=company.company_id) }}"
       class="sidebar-link {% if active_page == 'matches' %}active{% endif %}">
      <span>Trade matches</span>
      {% if unread_counts and unread_counts.matches > 0 %}<span class="notification-badge">{{ unread_counts.matches }}</span>{% endif %}
    </a>
    <a href="{{ url_for('main.tradeflow_awaiting_signature', company_id=company.company_id) }}"
       class="sidebar-link {% if active_page == 'awaiting_signature' %}active{% endif %}">
      <span>Awaiting your signature</span>
      {% if unread_counts and unread_counts.awaiting_signature > 0 %}<span class="notification-badge">{{ unread_counts.awaiting_signature }}</span>{% endif %}
    </a>
    <a href="{{ url_for('main.tradeflow_awaiting_other_party', company_id=company.company_id) }}"
       class="sidebar-link {% if active_page == 'awaiting_other_party' %}active{% endif %}">
      <span>Awaiting other party</span>
      {% if unread_counts and unread_counts.awaiting_other_party > 0 %}<span class="notification-badge">{{ unread_counts.awaiting_other_party }}</span>{% endif %}
    </a>
  </div>

  <div class="sidebar-section">
    <div class="sidebar-section-title">Deals</div>
    <a href="{{ url_for('main.tradeflow_ongoing_deals', company_id=company.company_id) }}"
       class="sidebar-link {% if active_page == 'ongoing' %}active{% endif %}">
      <span>Ongoing deals</span>
      {% if unread_counts and unread_counts.ongoing > 0 %}<span class="notification-badge">{{ unread_counts.ongoing }}</span>{% endif %}
    </a>
    <a href="{{ url_for('main.tradeflow_completed_deals', company_id=company.company_id) }}"
       class="sidebar-link {% if active_page == 'completed' %}active{% endif %}">
      <span>Completed deals</span>
      {% if unread_counts and unread_counts.completed > 0 %}<span class="notification-badge">{{ unread_counts.completed }}</span>{% endif %}
    </a>
  </div>
</aside>

<script>
(function() {
    const companySelectBtn = document.getElementById('company-select-btn');
    const companyDropdownMenu = document.getElementById('company-dropdown-menu');
    
    if (!companySelectBtn || !companyDropdownMenu) return;
    
    // Toggle dropdown on button click
    companySelectBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        const isExpanded = companySelectBtn.getAttribute('aria-expanded') === 'true';
        companySelectBtn.setAttribute('aria-expanded', !isExpanded);
        companyDropdownMenu.classList.toggle('show', !isExpanded);
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!companySelectBtn.contains(e.target) && !companyDropdownMenu.contains(e.target)) {
            companySelectBtn.setAttribute('aria-expanded', 'false');
            companyDropdownMenu.classList.remove('show');
        }
    });
    
    // Close dropdown on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && companySelectBtn.getAttribute('aria-expanded') === 'true') {
            companySelectBtn.setAttribute('aria-expanded', 'false');
            companyDropdownMenu.classList.remove('show');
        }
    });
})();
</script>
