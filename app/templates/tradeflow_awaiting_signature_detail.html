{% extends "base.html" %}
{% block title %}Offer Detail – Barter.com{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='tradeflow.css') }}">
{% endblock %}

{% block content %}
<div class="tradeflow-container">
  {% include '_tradeflow_sidebar.html' %}

  <main class="tradeflow-main">
<a href="{{ url_for('main.tradeflow_awaiting_signature', company_id=company.company_id) }}" class="back-link">← Back to Waiting for You</a>
      <div class="detail-card">
        <h1 class="detail-title">Offer Details</h1>
        <p class="detail-subtitle">Review this offer and decide to accept or decline</p>
        
        {# User is to_company since they're being offered something #}
        {# from_service belongs to to_company, to_service belongs to from_company #}
        {# So to_company REQUESTS to_service (from from_company) and OFFERS from_service #}
        {% set requested_service = proposal.to_service %}
        {% set offered_service = proposal.from_service %}
        
        <div class="pair-grid">
          <div class="pair-side pair-side--request">
            <div class="pair-badge-wrapper">
              <span class="pair-badge-label pair-badge-label--request">You Request</span>
            </div>
            <div class="pair-label">{{ requested_service.company.name }} offers</div>
            <div class="pair-service pair-service--request">{{ requested_service.title }}</div>
            <div class="pair-desc">{{ requested_service.description }}</div>
          </div>
          <div class="pair-side pair-side--offer">
            <div class="pair-badge-wrapper">
              <span class="pair-badge-label pair-badge-label--offer">You Offer</span>
            </div>
            <div class="pair-label">{{ offered_service.company.name }} offers</div>
            <div class="pair-service pair-service--offer">{{ offered_service.title }}</div>
            <div class="pair-desc">{{ offered_service.description }}</div>
          </div>
        </div>
        
        <!-- Deal Balance Section -->
        {% if fairness_data %}
        <div class="section-divider">
          <h2 class="section-header">Deal Balance</h2>
          
          {# compute_fairness is called with (to_service, from_service) #}
          {# fairness_data.requested.svi = to_service SVI (what you request/receive) #}
          {# fairness_data.return.svi = from_service SVI (what you offer/give) #}
          {# fairness_ratio = return/requested = from_service/to_service = offered/requested #}
          {# ratio = offered / requested: <0.9 means you give less than you get (favorable) #}
          {% set ratio = fairness_data.fairness_ratio if fairness_data.fairness_ratio else 0 %}
          {% set requested_svi = fairness_data.requested.svi %}
          {% set offered_svi = fairness_data.return.svi %}
          
          {% set is_balanced = ratio >= 0.9 and ratio <= 1.1 %}
          {% set is_favorable = ratio < 0.9 %}
          {% set is_unfavorable = ratio > 1.1 %}
          
          <div class="deal-balance-card {% if is_balanced %}deal-balance-card--balanced{% elif is_favorable %}deal-balance-card--favorable{% else %}deal-balance-card--unbalanced{% endif %}">
            <div class="balance-status-header">
              <h3 class="balance-status-title">Balance Status</h3>
              <div class="balance-ratio {% if is_balanced %}balance-ratio--balanced{% elif is_favorable %}balance-ratio--favorable{% else %}balance-ratio--unbalanced{% endif %}">
                {{ "%.2f"|format(ratio) }}
              </div>
            </div>
            
            <div class="balance-verdict {% if is_balanced %}balance-verdict--balanced{% elif is_favorable %}balance-verdict--favorable{% else %}balance-verdict--unbalanced{% endif %}">
              {% if is_balanced %}
                ✅ Balanced
              {% elif is_favorable %}
                ⚠️ Unbalanced (in your favor)
              {% else %}
                ❌ Unbalanced (not in your favor)
              {% endif %}
            </div>
            
            <p class="balance-description">
              {% if is_balanced %}
                This is a fair trade. Both services have similar value.
              {% elif is_favorable %}
                You are receiving much more value than you give.
              {% else %}
                You are giving much more value than you receive. Consider negotiating.
              {% endif %}
            </p>
            
            <div class="value-comparison">
              <h4 class="value-comparison-title">Value comparison</h4>
              <div class="value-comparison-grid">
                <div class="value-comparison-side">
                  <div class="value-comparison-label">You request:</div>
                  <div class="value-comparison-service value-comparison-service--request">{{ requested_service.title }}</div>
                  <div class="svi-dots">
                    {% for i in range(5) %}
                      <div class="svi-dot {% if i < (requested_svi * 5)|round|int %}svi-dot--filled{% else %}svi-dot--empty{% endif %}"></div>
                    {% endfor %}
                  </div>
                </div>
                
                <div class="value-comparison-arrow">⇄</div>
                
                <div class="value-comparison-side">
                  <div class="value-comparison-label">You offer:</div>
                  <div class="value-comparison-service value-comparison-service--offer">{{ offered_service.title }}</div>
                  <div class="svi-dots">
                    {% for i in range(5) %}
                      <div class="svi-dot {% if i < (offered_svi * 5)|round|int %}svi-dot--filled{% else %}svi-dot--empty{% endif %}"></div>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
            
            <div class="balance-info-section">
              <h4 class="balance-info-title">What does this mean?</h4>
              <ul class="balance-info-list">
                {% if is_favorable %}
                  <li>You receive significantly more value</li>
                  <li>This deal might be seen as unfair</li>
                {% elif is_unfavorable %}
                  <li>You give significantly more value</li>
                  <li>Consider making a counter offer or declining</li>
                {% else %}
                  <li>Both parties receive similar value</li>
                  <li>This is a fair and balanced trade</li>
                {% endif %}
              </ul>
            </div>
          </div>
        </div>
        {% endif %}
        
        <div class="section-divider">
          <div class="section-header">Offer Terms</div>
          <div class="info-grid">
            <div class="info-box-bordered">
              <div class="info-box-label">Extra Payment</div>
              <div class="info-box-value">€{{ proposal.barter_coins_offered }}</div>
            </div>
            <div class="info-box-bordered">
              <div class="info-box-label">Created</div>
              <div class="info-box-value">{{ proposal.created_at.strftime('%d-%m-%Y') }}</div>
            </div>
          </div>
          
          {% if proposal.message %}
          <div class="message-box">
            <div class="message-label">Message from {{ proposal.from_company.name }}</div>
            <div class="message-text">{{ proposal.message }}</div>
          </div>
          {% endif %}
          
          <form method="POST">
            <div class="form-actions">
              <button type="submit" name="action" value="accept" class="btn-accept">Accept Offer</button>
              <a href="{{ url_for('main.tradeflow_match_detail', company_id=company.company_id, proposal_id=proposal.proposal_id) }}" class="btn-counter">Make Counter Offer</a>
            </div>
          </form>
          
          <form method="POST" action="{{ url_for('main.tradeflow_cancel_deal', company_id=company.company_id, proposal_id=proposal.proposal_id) }}" class="form-cancel">
            <button type="submit" class="btn-cancel" onclick="return confirm('Are you sure you want to cancel this deal? This will remove it completely from matches.');">Cancel Deal</button>
          </form>
        </div>
      </div>
  </main>
</div>
{% endblock %}
