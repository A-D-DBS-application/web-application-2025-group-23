{% extends "base.html" %}
{% block title %}Offer Detail – Barter.com{% endblock %}
{% block nav_tradeflow_active %}class="active"{% endblock %}
{% set active_page = 'awaiting_signature' %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='tradeflow.css') }}">
{% endblock %}

{% block content %}
<div class="tradeflow-container">
  {% include '_tradeflow_sidebar.html' %}

  <main class="tradeflow-main">
    <a href="{{ url_for('main.tradeflow_awaiting_signature', company_id=company.company_id) }}" class="back-link">← Back to Waiting for You</a>
    
    <h1 class="detail-title">Offer Details</h1>
    <p class="detail-subtitle">Review this offer and decide to accept or decline</p>
    
    <div class="detail-card">
        
        {# User is to_company since they're being offered something #}
        {# from_service belongs to to_company, to_service belongs to from_company #}
        {# So to_company REQUESTS to_service (from from_company) and OFFERS from_service #}
        {% set requested_service = proposal.to_service %}
        {% set offered_service = proposal.from_service %}
        
        <div class="pair-grid">
          <div class="pair-side pair-side--request">
            <div class="pair-badge-wrapper">
              <span class="pair-badge-label pair-badge-label--request">You Request</span>
            </div>
            <div class="pair-label">{{ requested_service.company.name }} offers</div>
            <div class="pair-service pair-service--request">{{ requested_service.title }}</div>
            <div class="pair-desc">{{ requested_service.description }}</div>
          </div>
          <div class="pair-side pair-side--offer">
            <div class="pair-badge-wrapper">
              <span class="pair-badge-label pair-badge-label--offer">You Offer</span>
            </div>
            <div class="pair-label">{{ offered_service.company.name }} offers</div>
            <div class="pair-service pair-service--offer">{{ offered_service.title }}</div>
            <div class="pair-desc">{{ offered_service.description }}</div>
          </div>
        </div>
        
        <!-- Details Section -->
        <div class="section-divider">
          <h2 class="section-header">Details</h2>
          
          <div class="info-grid">
            <div class="info-item">
              <div class="info-label">Status</div>
              <div class="info-value">{{ proposal.status }}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Created</div>
              <div class="info-value">{{ proposal.created_at.strftime('%d-%m-%Y') }}</div>
            </div>
            {% if proposal.message %}
            <div class="info-item">
              <div class="info-label">Message</div>
              <div class="info-value">{{ proposal.message }}</div>
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Deal Balance Section -->
        {% if fairness_data %}
        <div class="section-divider">
          <h2 class="section-header">Deal Balance</h2>
          
          {# compute_fairness is called with (to_service, from_service) #}
          {# fairness_data.requested.svi = to_service SVI (what you request/receive) #}
          {# fairness_data.return.svi = from_service SVI (what you offer/give) #}
          {# fairness_ratio = return/requested = from_service/to_service = offered/requested #}
          {# ratio = offered / requested: <0.9 means you give less than you get (favorable) #}
          {% set ratio = fairness_data.fairness_ratio if fairness_data.fairness_ratio else 0 %}
          {% set requested_svi = fairness_data.requested.svi %}
          {% set offered_svi = fairness_data.return.svi %}
          
          {% set is_balanced = ratio >= 0.9 and ratio <= 1.1 %}
          {% set is_favorable = ratio < 0.9 %}
          {% set is_unfavorable = ratio > 1.1 %}
          
          {# Check if money improves or worsens the deal #}
          {% set money_improves_deal = (proposal.money_type == 'give' and proposal.money_amount > 0) %}
          {% set money_worsens_deal = (proposal.money_type == 'receive' and proposal.money_amount > 0) %}
          
          <div class="deal-balance-card {% if is_balanced %}deal-balance-card--balanced{% elif is_favorable %}deal-balance-card--favorable{% else %}deal-balance-card--unbalanced{% endif %}">
            <div class="balance-status-header">
              <h3 class="balance-status-title">Balance Status</h3>
              <div class="balance-ratio {% if is_balanced %}balance-ratio--balanced{% elif is_favorable %}balance-ratio--favorable{% else %}balance-ratio--unbalanced{% endif %}">
                {{ "%.2f"|format(ratio) }}
              </div>
            </div>
            
            <div class="balance-verdict {% if is_balanced %}balance-verdict--balanced{% elif (is_favorable and not money_worsens_deal) or (is_unfavorable and money_improves_deal) %}balance-verdict--favorable{% else %}balance-verdict--unbalanced{% endif %}">
              {% if is_balanced %}
                ✅ Balanced
              {% elif is_favorable %}
                {% if money_worsens_deal %}
                  ❌ Unbalanced (in your favor, but you pay extra)
                {% else %}
                  ⚠️ Unbalanced (in your favor)
                {% endif %}
              {% else %}
                {% if money_improves_deal %}
                  ⚠️ Unbalanced (not in your favor, but they offer extra payment)
                {% else %}
                  ❌ Unbalanced (not in your favor)
                {% endif %}
              {% endif %}
            </div>
            
            <p class="balance-description">
              {% if is_balanced %}
                This is a fair trade. Both services have similar value.
              {% elif is_favorable %}
                {% if money_worsens_deal %}
                  You receive more value, but you also need to pay €{{ proposal.money_amount }}.
                {% else %}
                  You are receiving much more value than you give.
                {% endif %}
              {% else %}
                {% if money_improves_deal %}
                  You give more value, but they're offering €{{ proposal.money_amount }} to compensate - this could be a good deal.
                {% else %}
                  You are giving much more value than you receive.
                {% endif %}
              {% endif %}
            </p>
            
            <div class="value-comparison">
              <h4 class="value-comparison-title">Value comparison</h4>
              <div class="value-comparison-grid">
                <div class="value-comparison-side">
                  <div class="value-comparison-label">You request:</div>
                  <div class="value-comparison-service value-comparison-service--request">{{ requested_service.title }}</div>
                  <div class="svi-dots">
                    {% for i in range(5) %}
                      <div class="svi-dot {% if i < (requested_svi * 5)|round|int %}svi-dot--filled{% else %}svi-dot--empty{% endif %}"></div>
                    {% endfor %}
                  </div>
                </div>
                
                <div class="value-comparison-arrow">⇄</div>
                
                <div class="value-comparison-side">
                  <div class="value-comparison-label">You offer:</div>
                  <div class="value-comparison-service value-comparison-service--offer">{{ offered_service.title }}</div>
                  <div class="svi-dots">
                    {% for i in range(5) %}
                      <div class="svi-dot {% if i < (offered_svi * 5)|round|int %}svi-dot--filled{% else %}svi-dot--empty{% endif %}"></div>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
            
            <div class="balance-info-section">
              <h4 class="balance-info-title">What does this mean?</h4>
              <ul class="balance-info-list">
                {% if is_favorable %}
                  <li>You receive significantly more value in the services</li>
                  {% if money_worsens_deal %}
                    <li>However, you need to pay €{{ proposal.money_amount }}</li>
                    <li>This could still be a reasonable trade if you value their service highly</li>
                  {% else %}
                    <li>This deal might be seen as unfair to them</li>
                  {% endif %}
                {% elif is_unfavorable %}
                  <li>You give significantly more value in the services</li>
                  {% if money_improves_deal %}
                    <li>They offer €{{ proposal.money_amount }} to compensate for the difference</li>
                    <li>This makes the deal fairer - consider if it's acceptable</li>
                  {% else %}
                    <li>Consider declining and making a counter offer</li>
                  {% endif %}
                {% else %}
                  <li>Both parties receive similar value</li>
                  <li>This is a fair and balanced trade</li>
                {% endif %}
              </ul>
            </div>
            
            {% if not is_balanced %}
            <div class="balance-info-section">
              <h4 class="balance-info-title">Your options:</h4>
              <ul class="balance-info-list">
                {% if is_favorable %}
                  <li>Accept the offer if you value their service</li>
                  <li>Decline if you think they should offer more</li>
                {% else %}
                  {% if money_improves_deal %}
                    <li>Accept if you think the €{{ proposal.money_amount }} compensation is fair</li>
                    <li>Decline if you want a better deal</li>
                  {% else %}
                    <li>Decline and suggest a counter offer</li>
                  {% endif %}
                {% endif %}
              </ul>
            </div>
            {% endif %}
            
            <details class="balance-details">
              <summary class="balance-details-summary">How is this calculated? ▼</summary>
              <div class="balance-details-content">
                <p class="balance-details-text">The score is calculated by comparing the Service Value Index (SVI) of the offered service with that of the requested service.</p>
                <div class="balance-details-grid">
                  <div>
                    <div class="balance-details-label">You request</div>
                    <div class="balance-details-value">Service Value: {{ requested_svi|round(2) }}</div>
                  </div>
                  <div>
                    <div class="balance-details-label">You offer</div>
                    <div class="balance-details-value">Service Value: {{ offered_svi|round(2) }}</div>
                  </div>
                </div>
                <p class="balance-details-footnote">Calculated from effort, demand, reviews and trust</p>
              </div>
            </details>
          </div>
        </div>
        {% endif %}

        <!-- Money Compensation Section -->
        {% set money_type = proposal.money_type if proposal.money_type is defined else None %}
        {% set money_amount = proposal.money_amount if proposal.money_amount is defined else None %}
        {# For awaiting_signature, we are the receiving party, so money types are inverted #}
        {# If sender marked 'give', we 'receive'. If sender marked 'receive', we 'give' #}
        {% set viewer_money_type = 'receive' if money_type == 'give' else ('give' if money_type == 'receive' else None) %}
        {% if money_amount and money_amount|int > 0 and viewer_money_type %}
        <div class="section-divider">
          <h2 class="section-header">Money Compensation</h2>
          
          <div class="form-card">
            <div class="form-card-header">
              <div>
                <h3 class="form-card-title">Additional Payment</h3>
                <p class="form-card-subtitle">Extra money to balance this trade</p>
              </div>
            </div>
            
            <div class="money-preview {% if viewer_money_type == 'receive' %}money-preview--receive{% else %}money-preview--give{% endif %}">
              <div class="money-preview-label">
                {% if viewer_money_type == 'receive' %}
                You will receive
                {% else %}
                You will give
                {% endif %}
              </div>
              <div class="money-preview-amount">€{{ money_amount }}</div>
              <div class="money-preview-suffix">as part of this deal</div>
            </div>
          </div>
        </div>
        {% endif %}

        <!-- Action Footer -->
        <div class="detail-action-footer">
          <div class="action-footer-left">
            <form method="POST" action="{{ url_for('main.tradeflow_cancel_deal', company_id=company.company_id, proposal_id=proposal.proposal_id) }}" style="margin: 0;">
              <button type="submit" class="btn-cancel" onclick="return confirm('Are you sure you want to cancel this deal? This will remove it completely from matches.');">Cancel Deal</button>
            </form>
          </div>
          <div class="action-footer-right">
            <a href="{{ url_for('main.tradeflow_match_detail', company_id=company.company_id, proposal_id=proposal.proposal_id) }}" class="btn-counter">Make Counter Offer</a>
            <form method="POST" style="margin: 0;">
              <button type="submit" name="action" value="accept" class="btn-accept">Accept Offer</button>
            </form>
          </div>
        </div>
      </div>
  </main>
</div>
{% endblock %}
