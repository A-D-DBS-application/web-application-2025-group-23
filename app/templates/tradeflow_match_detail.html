{% extends "base.html" %}
{% block title %}Match Detail – Barter.com{% endblock %}
{% block nav_tradeflow_active %}class="active"{% endblock %}
{% set active_page = 'matches' %}

{% block content %}
<div class="tradeflow-container">
    {% include '_tradeflow_sidebar.html' %}

    <main class="main">
      <a href="{{ url_for('main.tradeflow_match_made', company_id=company.company_id) }}" class="back-link">← Back to Matches</a>
      
      <h1 class="detail-page-title">Create Offer</h1>
      <p class="detail-page-subtitle">Check the balance of your offer</p>
      
      <div class="detail-card detail-card--full-width">
        <!-- Service Cards -->
        {% if company.company_id == proposal.from_company.company_id %}
          {# Current user is from_company #}
          {# from_service belongs to to_company, to_service belongs to from_company #}
          {# So from_company REQUESTS from_service (from to_company) and OFFERS to_service #}
          {% set requested_service = proposal.from_service %}
          {% set offered_service = proposal.to_service %}
          {% set is_from_company = true %}
        {% else %}
          {# Current user is to_company #}
          {# from_service belongs to to_company, to_service belongs to from_company #}
          {# So to_company REQUESTS to_service (from from_company) and OFFERS from_service #}
          {% set requested_service = proposal.to_service %}
          {% set offered_service = proposal.from_service %}
          {% set is_from_company = false %}
        {% endif %}
        
        <div class="pair-grid">
          <div class="pair-side pair-side--request">
            <div class="pair-badge">
              <span class="pair-badge-label pair-badge-label--request">You Request</span>
            </div>
            <div class="pair-label">{{ requested_service.company.name }} offers</div>
            <div class="pair-service pair-service--request">{{ requested_service.title }}</div>
            <div class="pair-desc">{{ requested_service.description }}</div>
          </div>
          <div class="pair-side pair-side--offer">
            <div class="pair-badge">
              <span class="pair-badge-label pair-badge-label--offer">You Offer</span>
            </div>
            <div class="pair-label">{{ offered_service.company.name }} offers</div>
            <div class="pair-service pair-service--offer">{{ offered_service.title }}</div>
            <div class="pair-desc">{{ offered_service.description }}</div>
          </div>
        </div>
        
        <!-- Details Section -->
        <div class="section-divider">
          <h2 class="section-header">Details</h2>
          
          <div class="info-box-bordered">
            <div class="info-grid">
              <div class="info-item">
                <div class="info-label">Status</div>
                <div class="info-value">{{ proposal.status }}</div>
              </div>
              <div class="info-item">
                <div class="info-label">Created</div>
                <div class="info-value">{{ proposal.created_at.strftime('%d-%m-%Y') }}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Deal Balance Section -->
        {% if fairness_data %}
        <div class="section-divider">
          <h2 class="section-header">Deal Balance</h2>
          
          {# compute_fairness is called with (from_service, to_service) #}
          {# So: fairness_data.requested = from_service SVI, fairness_data.return = to_service SVI #}
          {# fairness_ratio = return.svi / requested.svi = to_service / from_service #}
          {% if is_from_company %}
            {# from_company: requests from_service, offers to_service #}
            {# requested_svi = from_service SVI = fairness_data.requested.svi #}
            {# offered_svi = to_service SVI = fairness_data.return.svi #}
            {# ratio from user perspective = offered / requested = to / from = fairness_ratio #}
            {% set ratio = fairness_data.fairness_ratio %}
            {% set requested_svi = fairness_data.requested.svi %}
            {% set offered_svi = fairness_data.return.svi %}
          {% else %}
            {# to_company: requests to_service, offers from_service #}
            {# requested_svi = to_service SVI = fairness_data.return.svi #}
            {# offered_svi = from_service SVI = fairness_data.requested.svi #}
            {# ratio from user perspective = offered / requested = from / to = 1 / fairness_ratio #}
            {% set ratio = 1 / fairness_data.fairness_ratio if fairness_data.fairness_ratio != 0 else 0 %}
            {% set requested_svi = fairness_data.return.svi %}
            {% set offered_svi = fairness_data.requested.svi %}
          {% endif %}
          
          {% set is_balanced = ratio >= 0.9 and ratio <= 1.1 %}
          {% set is_favorable = ratio < 0.9 %}
          {% set is_unfavorable = ratio > 1.1 %}
          
          <div class="deal-balance-card {% if is_balanced %}deal-balance-card--balanced{% else %}deal-balance-card--unbalanced{% endif %}">
            <div class="balance-header">
              <div class="balance-header-content">
                <h3 class="balance-title">Balance Status</h3>
              </div>
              <div class="balance-score-wrapper">
                <div class="balance-score-label">Fairness score:</div>
                <div class="balance-score {% if is_balanced %}balance-score--balanced{% else %}balance-score--unbalanced{% endif %}">{{ ratio|round(2) }}</div>
              </div>
            </div>
            
            <div class="balance-status">
              <div>
                <div class="balance-status-text {% if is_balanced %}balance-status-text--balanced{% else %}balance-status-text--unbalanced{% endif %}">
                  {% if is_balanced %}
                  Balanced deal
                  {% elif is_favorable %}
                  Unbalanced (in your favor)
                  {% else %}
                  Unbalanced (in their favor)
                  {% endif %}
                </div>
                <div class="balance-status-desc">
                  {% if is_balanced %}
                  Both sides are offering similar value.
                  {% elif is_favorable %}
                  You are receiving more value than you give.
                  {% else %}
                  You are giving more value than you receive.
                  {% endif %}
                </div>
              </div>
            </div>
            
            <div class="value-comparison">
              <h4 class="value-comparison-title">Value comparison</h4>
              <div class="value-comparison-grid">
                <div class="value-comparison-item">
                  <div class="value-comparison-label">You request:</div>
                  <div class="value-comparison-service">{{ requested_service.title }}</div>
                  <div class="svi-dots">
                    {% for i in range(5) %}
                    <span class="svi-dot {% if i < (requested_svi * 5)|round|int %}svi-dot--filled{% else %}svi-dot--empty{% endif %}"></span>
                    {% endfor %}
                  </div>
                </div>
                
                <div class="value-comparison-arrow">⇄</div>
                
                <div class="value-comparison-item">
                  <div class="value-comparison-label">You offer:</div>
                  <div class="value-comparison-service">{{ offered_service.title }}</div>
                  <div class="svi-dots">
                    {% for i in range(5) %}
                    <span class="svi-dot {% if i < (offered_svi * 5)|round|int %}svi-dot--filled{% else %}svi-dot--empty{% endif %}"></span>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
            
            <div class="balance-info-section">
              <h4 class="balance-info-title">What does this mean?</h4>
              <ul class="balance-info-list">
                {% if is_balanced %}
                <li>Both parties receives similar value</li>
                <li>This deal is likely to be accepted</li>
                {% elif is_favorable %}
                <li>You receive significantly more value</li>
                <li>This deal might be seen as unfair</li>
                <li>Your partner may reject this offer</li>
                {% else %}
                <li>You give significantly more value</li>
                <li>This deal might be seen as unfair</li>
                <li>Consider what you're giving up</li>
                {% endif %}
              </ul>
            </div>
            
            {% if not is_balanced %}
            <div class="balance-info-section">
              <h4 class="balance-info-title">Suggested actions:</h4>
              <ul class="balance-info-list">
                {% if is_favorable %}
                <li>Offer something extra</li>
                <li>Ask for less in return</li>
                <li>Proceed anyway</li>
                {% else %}
                <li>Ask for something extra</li>
                <li>Offer less in return</li>
                <li>Proceed anyway</li>
                {% endif %}
              </ul>
            </div>
            {% endif %}
            
            <details class="balance-details">
              <summary>How is this calculated? ▼</summary>
              <div class="balance-details-content">
                <p class="balance-details-text">The score is calculated by comparing the Service Value Index (SVI) of the offered service with that of the requested service.</p>
                <div class="balance-details-grid">
                  <div>
                    <div class="balance-details-item-title">You request</div>
                    <div class="balance-details-item-value">Service Value: {{ requested_svi|round(2) }}</div>
                  </div>
                  <div>
                    <div class="balance-details-item-title">You offer</div>
                    <div class="balance-details-item-value">Service Value: {{ offered_svi|round(2) }}</div>
                  </div>
                </div>
                <p class="balance-details-note">Calculated from effort, demand, reviews and trust</p>
              </div>
            </details>
          </div>
        </div>
        {% endif %}

        <!-- Create Offer Section -->
        <div class="section-divider">
          <h2 class="section-header">Create Offer</h2>
          <p class="detail-page-subtitle mb-0">Finalize the details of this trade</p>
          
          <form method="POST" action="{{ url_for('main.tradeflow_match_detail', company_id=company.company_id, proposal_id=proposal.proposal_id) }}" class="mt-24">
            
            <!-- Money Compensation Card -->
            <div class="form-card">
              <div class="form-card-header">
                <div>
                  <h3 class="form-card-title">Money Compensation (Optional)</h3>
                  <p class="form-card-subtitle">Add money to balance the trade or leave at €0 for service-only exchange</p>
                </div>
              </div>
              
              <div class="toggle-buttons">
                <button type="button" class="toggle-btn active" data-type="receive" onclick="setMoneyType('receive')">
                  I Want (€)
                </button>
                <button type="button" class="toggle-btn" data-type="give" onclick="setMoneyType('give')">
                  I Give (€)
                </button>
              </div>
              
              <div class="money-input-container">
                <div class="money-input-wrapper">
                  <label class="money-label">Amount</label>
                  <div class="money-input-row">
                    <span class="money-symbol">€</span>
                    <input type="number" id="moneyInput" class="money-input" min="0" max="10000" value="0" step="10" placeholder="0" oninput="updateMoneyDisplay()">
                  </div>
                </div>
              </div>
              
              <div id="moneyPreview" class="money-preview">
                No additional money specified
              </div>
              
              <input type="hidden" id="moneyAmount" name="money_amount" value="0">
              <input type="hidden" id="moneyType" name="money_type" value="receive">
            </div>

            <!-- Terms & Conditions Card -->
            <div class="form-card">
              <div class="form-card-header">
                <div>
                  <h3 class="form-card-title">Message & Terms</h3>
                  <p class="form-card-subtitle">Add specific terms, conditions, or notes about this deal</p>
                </div>
              </div>
              <textarea name="message" class="message-textarea" placeholder="Example: Service will be delivered within 2 weeks. Payment due upon completion..."></textarea>
            </div>

            <!-- Action Buttons -->
            <div class="form-actions">
              <button type="submit" class="btn-primary">
                Send Offer
              </button>
              <a href="{{ url_for('main.tradeflow_match_made', company_id=company.company_id) }}" class="btn-secondary">
                Cancel
              </a>
            </div>
            
            <!-- Info Notice -->
            <div class="notice">
              <p>
                <strong>Next step:</strong> Your proposal will move to "Awaiting other party", where they can accept or counter.
              </p>
            </div>
          </form>
        </div>
      </div>
    </main>
  </div>

<script>
function setMoneyType(type) {
  document.getElementById('moneyType').value = type;
  
  document.querySelectorAll('.toggle-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  event.target.classList.add('active');
  
  updateMoneyDisplay();
}

function updateMoneyDisplay() {
  const input = document.getElementById('moneyInput');
  const amount = parseInt(input.value) || 0;
  const type = document.getElementById('moneyType').value;
  
  document.getElementById('moneyAmount').value = amount;
  
  const preview = document.getElementById('moneyPreview');
  preview.classList.remove('money-preview--receive', 'money-preview--give');
  
  if (amount === 0) {
    preview.innerHTML = 'No additional money specified';
  } else {
    const verb = type === 'receive' ? 'will receive' : 'will give';
    preview.innerHTML = `You ${verb} <strong>€${amount}</strong> as part of this deal`;
    preview.classList.add(type === 'receive' ? 'money-preview--receive' : 'money-preview--give');
  }
}

document.addEventListener('DOMContentLoaded', function() {
  updateMoneyDisplay();
});
</script>
{% endblock %}
