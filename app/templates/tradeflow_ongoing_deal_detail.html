{% extends "base.html" %}
{% block title %}Ongoing Deal Detail – Barter.com{% endblock %}
{% block nav_tradeflow_active %}class="active"{% endblock %}
{% set active_page = 'ongoing' %}

{% block content %}
<div class="tradeflow-container">
    {% include '_tradeflow_sidebar.html' %}

    <main class="main">
      <a href="{{ url_for('main.tradeflow_ongoing_deals', company_id=company.company_id) }}" class="back-link">← Back to Deals</a>
      <div class="detail-card">
        <h1 style="font-size: 28px; margin-bottom: 8px;">Ongoing Deal</h1>
        <p style="color: #5f6368; margin-bottom: 28px;">Track service delivery and confirm when received</p>
        
        <div class="pair-grid">
          <div class="pair-side">
            <div class="pair-label">{{ proposal.from_company.name }} provides</div>
            <div class="pair-service">{{ proposal.from_service.title }}</div>
            <div class="pair-desc">{{ proposal.from_service.description }}</div>
          </div>
          <div class="pair-side">
            <div class="pair-label">{{ proposal.to_company.name }} provides</div>
            <div class="pair-service">{{ proposal.to_service.title }}</div>
            <div class="pair-desc">{{ proposal.to_service.description }}</div>
          </div>
        </div>

        <div style="border-top: 1px solid #e8eaed; padding-top: 24px; margin-top: 24px;">
          <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 16px;">Delivery Status</h2>
          <div class="status-grid">
            <div class="status-item">
              <div class="status-label">{{ proposal.from_company.name }} delivered?</div>
              <div class="status-value {% if active_deal.from_company_completed %}confirmed{% else %}pending{% endif %}">
                {% if active_deal.from_company_completed %}✓ Confirmed{% else %}⏳ Pending{% endif %}
              </div>
            </div>
            <div class="status-item">
              <div class="status-label">{{ proposal.to_company.name }} delivered?</div>
              <div class="status-value {% if active_deal.to_company_completed %}confirmed{% else %}pending{% endif %}">
                {% if active_deal.to_company_completed %}✓ Confirmed{% else %}⏳ Pending{% endif %}
              </div>
            </div>
          </div>

          {% set other_company_name = proposal.to_company.name if company.company_id == proposal.from_company_id else proposal.from_company.name %}
          {% set other_delivered = active_deal.to_company_completed if company.company_id == proposal.from_company_id else active_deal.from_company_completed %}
          
          {% if not other_delivered %}
          <div class="action-buttons">
            <form method="POST">
              <button type="submit" class="btn btn-success">Confirm {{ other_company_name }} Delivered</button>
            </form>
          </div>
          {% else %}
          <div style="background: #e8f5e9; border-left: 4px solid #34a853; padding: 16px; border-radius: 6px; margin-top: 20px;">
            <p style="color: #1b5e20; font-weight: 600;">✓ You've confirmed {{ other_company_name }} delivered their service</p>
          </div>
          {% endif %}
        </div>
      </div>
    </main>
  </div>
{% endblock %}
