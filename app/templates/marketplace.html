{% extends "base.html" %}
{% block title %}Marketplace | Barter.com{% endblock %}
{% block nav_marketplace_active %}class="active"{% endblock %}

{% block content %}
    <div class="marketplace-container">
        <div class="marketplace-header">
            <h1>Service Marketplace</h1>
            <div class="company-selector" style="gap: 0.5rem; align-items: center;">
                <span style="font-size: 14px; color: #4a5568;">Browsing as <strong>{{ selected_company.name }}</strong></span>
                <a href="{{ url_for('main.select_company_for_marketplace') }}" style="font-size: 14px; color: #1A73E8; text-decoration: none;">Switch company</a>
            </div>
        </div>

        <div class="filters">
            <form method="get" style="display: flex; gap: 1rem; width: 100%;">
                <input type="hidden" name="company_id" value="{{ selected_company.company_id }}">
                <input type="text" name="search" placeholder="Search services..." class="search-bar" value="{{ search_query or '' }}">
                <select name="category" class="category-filter" onchange="this.form.submit()">
                    <option value="">All Categories</option>
                    <option value="Finance" {% if category_filter == 'Finance' %}selected{% endif %}>Finance</option>
                    <option value="Accounting" {% if category_filter == 'Accounting' %}selected{% endif %}>Accounting</option>
                    <option value="IT" {% if category_filter == 'IT' %}selected{% endif %}>IT</option>
                    <option value="Marketing" {% if category_filter == 'Marketing' %}selected{% endif %}>Marketing</option>
                    <option value="Legal" {% if category_filter == 'Legal' %}selected{% endif %}>Legal</option>
                    <option value="Design" {% if category_filter == 'Design' %}selected{% endif %}>Design</option>
                    <option value="Development" {% if category_filter == 'Development' %}selected{% endif %}>Development</option>
                    <option value="Consulting" {% if category_filter == 'Consulting' %}selected{% endif %}>Consulting</option>
                    <option value="Sales" {% if category_filter == 'Sales' %}selected{% endif %}>Sales</option>
                    <option value="HR" {% if category_filter == 'HR' %}selected{% endif %}>HR</option>
                    <option value="Operations" {% if category_filter == 'Operations' %}selected{% endif %}>Operations</option>
                    <option value="Customer Support" {% if category_filter == 'Customer Support' %}selected{% endif %}>Customer Support</option>
                </select>
                <button type="submit" style="padding: 0.75rem 1.5rem; background: #1A73E8; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">Search</button>
            </form>
        </div>

        <div class="services-grid">
            {% for service in services %}
            <div class="service-card" data-category="{{ service.categories }}">
                <div class="service-header">
                    <h3>{{ service.title }}</h3>
                    <span class="service-company">by {{ service.company.name }}</span>
                </div>
                <div class="service-body">
                    <p class="service-description">{{ service.description[:150] }}{% if service.description|length > 150 %}...{% endif %}</p>
                    {% if service.categories %}
                        <div class="service-categories">
                            {% for cat in service.categories.split(',') %}
                                <span class="category-tag">{{ cat.strip() }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div class="service-footer">
                    <div class="service-meta">
                        {% set rating_key = service.service_id|string %}
                        {% if rating_key in service_ratings %}
                        <div style="color: #fbbf24; font-size: 14px;">
                            â˜… {{ "%.1f"|format(service_ratings[rating_key].avg) }} ({{ service_ratings[rating_key].count }} reviews)
                        </div>
                        {% endif %}
                        <span class="duration">{{ service.duration_hours }} hours</span>
                    </div>
                    <a href="{{ url_for('main.marketplace_service_view', service_id=service.service_id) }}" class="btn-view">View Details</a>
                </div>
            </div>
            {% else %}
            <div class="no-services">
                <p>No services available in the marketplace yet.</p>
            </div>
            {% endfor %}
        </div>

        {% if pagination and pagination.pages > 1 %}
        <div class="pagination" style="margin-top: 1.5rem; display: flex; align-items: center; gap: 1rem; justify-content: center;">
            {% if pagination.has_prev %}
                <a class="page-link" href="{{ url_for('main.marketplace', page=pagination.prev_num, company_id=selected_company.company_id, search=search_query, category=category_filter) }}" style="padding: 0.5rem 0.75rem; border: 1px solid #e2e8f0; border-radius: 6px; color: #4a5568; text-decoration: none;">&larr; Previous</a>
            {% else %}
                <span class="page-link disabled" style="padding: 0.5rem 0.75rem; border: 1px solid #e2e8f0; border-radius: 6px; color: #cbd5e0;">&larr; Previous</span>
            {% endif %}

            <span class="page-info" style="font-size: 14px; color: #4a5568;">Page {{ pagination.page }} of {{ pagination.pages }}</span>

            {% if pagination.has_next %}
                <a class="page-link" href="{{ url_for('main.marketplace', page=pagination.next_num, company_id=selected_company.company_id, search=search_query, category=category_filter) }}" style="padding: 0.5rem 0.75rem; border: 1px solid #e2e8f0; border-radius: 6px; color: #4a5568; text-decoration: none;">Next &rarr;</a>
            {% else %}
                <span class="page-link disabled" style="padding: 0.5rem 0.75rem; border: 1px solid #e2e8f0; border-radius: 6px; color: #cbd5e0;">Next &rarr;</span>
            {% endif %}
        </div>
        {% endif %}
    </div>
{% endblock %}
