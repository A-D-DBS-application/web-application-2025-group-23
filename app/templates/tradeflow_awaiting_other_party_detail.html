{% extends "base.html" %}
{% block title %}Offer Detail – Barter.com{% endblock %}
{% block nav_tradeflow_active %}class="active"{% endblock %}
{% set active_page = 'awaiting_other_party' %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='tradeflow.css') }}">
{% endblock %}

{% block content %}
<div class="tradeflow-container">
    {% include '_tradeflow_sidebar.html' %}

    <main class="tradeflow-main">
      <a href="{{ url_for('main.tradeflow_awaiting_other_party', company_id=company.company_id) }}" class="back-link">← Back to Awaiting Them</a>
      
      <h1 class="detail-title">Offer Details</h1>
      <p class="detail-subtitle">This proposal is waiting for {{ proposal.to_company.name }} to respond</p>
      
      <div class="detail-card">
        <!-- Service Cards -->
        {# In awaiting_other_party, user is always from_company (they sent the offer) #}
        {# from_service belongs to to_company, to_service belongs to from_company #}
        {# So from_company REQUESTS from_service (from to_company) and OFFERS to_service #}
        {# fairness is computed as (to_service, from_service) so: #}
        {# fairness_data.requested = to_service SVI (what you offer), fairness_data.return = from_service SVI (what you request) #}
        {% set requested_service = proposal.from_service %}
        {% set offered_service = proposal.to_service %}
        {% set requested_svi = fairness_data.return.svi if fairness_data else 0 %}
        {% set offered_svi = fairness_data.requested.svi if fairness_data else 0 %}
        
        <div class="pair-grid">
          <div class="pair-side pair-side--request">
            <div class="pair-badge-wrapper">
              <span class="pair-badge-label pair-badge-label--request">You Request</span>
            </div>
            <div class="pair-label">{{ requested_service.company.name }} offers</div>
            <div class="pair-service pair-service--request">{{ requested_service.title }}</div>
            <div class="pair-desc">{{ requested_service.description }}</div>
          </div>
          <div class="pair-side pair-side--offer">
            <div class="pair-badge-wrapper">
              <span class="pair-badge-label pair-badge-label--offer">You Offer</span>
            </div>
            <div class="pair-label">{{ offered_service.company.name }} offers</div>
            <div class="pair-service pair-service--offer">{{ offered_service.title }}</div>
            <div class="pair-desc">{{ offered_service.description }}</div>
          </div>
        </div>
        
        <!-- Details Section -->
        <div class="section-divider">
          <h2 class="section-header">Details</h2>
          
          <div class="info-grid">
            <div class="info-item">
              <div class="info-label">Status</div>
              <div class="info-value">{{ proposal.status }}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Created</div>
              <div class="info-value">{{ proposal.created_at.strftime('%d-%m-%Y') }}</div>
            </div>
            {% if proposal.message %}
            <div class="info-item">
              <div class="info-label">Message</div>
              <div class="info-value">{{ proposal.message }}</div>
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Deal Balance Section -->
        {% if fairness_data %}
        <div class="section-divider">
          <h2 class="section-header">Deal Balance</h2>
          
          {# compute_fairness is called with (to_service, from_service) for awaiting_other_party #}
          {# So: fairness_data.requested = to_service SVI, fairness_data.return = from_service SVI #}
          {# fairness_ratio = return/requested = from/to #}
          {# User is from_company: requests from_service (return), offers to_service (requested) #}
          {# ratio from user perspective = offered / requested = to / from = 1 / fairness_ratio #}
          {% set ratio = 1 / fairness_data.fairness_ratio if fairness_data.fairness_ratio != 0 else 0 %}
          
          {% set is_balanced = ratio >= 0.9 and ratio <= 1.1 %}
          {% set is_favorable = ratio < 0.9 %}
          {% set is_unfavorable = ratio > 1.1 %}
          
          <div class="deal-balance-card {% if is_balanced %}deal-balance-card--balanced{% elif is_favorable %}deal-balance-card--favorable{% else %}deal-balance-card--unbalanced{% endif %}">
            <div class="balance-status-header">
              <div>
                <h3 class="balance-status-title">Balance Status</h3>
              </div>
              <div class="balance-score-wrapper">
                <div class="balance-score-label">Fairness score:</div>
                <div class="balance-ratio {% if is_balanced %}balance-ratio--balanced{% elif is_favorable %}balance-ratio--favorable{% else %}balance-ratio--unbalanced{% endif %}">{{ ratio|round(2) }}</div>
              </div>
            </div>
            
            <div class="balance-verdict-wrapper">
              <div>
                <div class="balance-verdict {% if is_balanced %}balance-verdict--balanced{% elif is_favorable %}balance-verdict--favorable{% else %}balance-verdict--unbalanced{% endif %}">
                  {% if is_balanced %}
                  Balanced deal
                  {% elif is_favorable %}
                  Unbalanced (in your favor)
                  {% else %}
                  Unbalanced (in their favor)
                  {% endif %}
                </div>
                <div class="balance-description">
                  {% if is_balanced %}
                  Both sides are offering similar value.
                  {% elif is_favorable %}
                  You are receiving more value than you give.
                  {% else %}
                  You are giving more value than you receive.
                  {% endif %}
                </div>
              </div>
            </div>
            
            <div class="balance-comparison-section">
              <h4 class="value-comparison-title">Value comparison</h4>
              <div class="value-comparison-grid">
                <div class="value-comparison-side">
                  <div class="value-comparison-label">You request:</div>
                  <div class="value-comparison-service">{{ requested_service.title }}</div>
                  <div class="svi-dots">
                    {% for i in range(5) %}
                    <span class="svi-dot {% if i < (requested_svi * 5)|round|int %}svi-dot--filled{% else %}svi-dot--empty{% endif %}"></span>
                    {% endfor %}
                  </div>
                </div>
                
                <div class="value-comparison-arrow">⇄</div>
                
                <div class="value-comparison-side">
                  <div class="value-comparison-label">You offer:</div>
                  <div class="value-comparison-service">{{ offered_service.title }}</div>
                  <div class="svi-dots">
                    {% for i in range(5) %}
                    <span class="svi-dot {% if i < (offered_svi * 5)|round|int %}svi-dot--filled{% else %}svi-dot--empty{% endif %}"></span>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
            
            <div class="balance-info-section">
              <h4 class="balance-info-title">What does this mean?</h4>
              <ul class="balance-info-list">
                {% if is_balanced %}
                <li>Both parties receives similar value</li>
                <li>This deal is likely to be accepted</li>
                {% elif is_favorable %}
                <li>You receive significantly more value</li>
                <li>This deal might be seen as unfair</li>
                <li>Your partner may reject this offer</li>
                {% else %}
                <li>You give significantly more value</li>
                <li>This deal might be seen as unfair</li>
                <li>Consider what you're giving up</li>
                {% endif %}
              </ul>
            </div>
            
            {% if not is_balanced %}
            <div class="balance-info-section">
              <h4 class="balance-info-title">Suggested actions:</h4>
              <ul class="balance-info-list">
                {% if is_favorable %}
                <li>Offer something extra</li>
                <li>Ask for less in return</li>
                <li>Proceed anyway</li>
                {% else %}
                <li>Ask for something extra</li>
                <li>Offer less in return</li>
                <li>Proceed anyway</li>
                {% endif %}
              </ul>
            </div>
            {% endif %}
            
            <details class="balance-details">
              <summary class="balance-details-summary">How is this calculated? ▼</summary>
              <div class="balance-details-content">
                <p class="balance-details-text">The score is calculated by comparing the Service Value Index (SVI) of the offered service with that of the requested service.</p>
                <div class="balance-details-grid">
                  <div>
                    <div class="balance-details-label">You request</div>
                    <div class="balance-details-value">Service Value: {{ requested_svi|round(2) }}</div>
                  </div>
                  <div>
                    <div class="balance-details-label">You offer</div>
                    <div class="balance-details-value">Service Value: {{ offered_svi|round(2) }}</div>
                  </div>
                </div>
                <p class="balance-details-footnote">Calculated from effort, demand, reviews and trust</p>
              </div>
            </details>
          </div>
        </div>
        {% endif %}

        <!-- Money Compensation Section -->
        {% set money_type = proposal.money_type if proposal.money_type is defined else None %}
        {% set money_amount = proposal.money_amount if proposal.money_amount is defined else None %}
        {% if money_amount and money_amount|int > 0 and money_type %}
        <div class="section-divider">
          <h2 class="section-header">Money Compensation</h2>
          
          <div class="form-card">
            <div class="form-card-header">
              <div>
                <h3 class="form-card-title">Additional Payment</h3>
                <p class="form-card-subtitle">Extra money to balance this trade</p>
              </div>
            </div>
            
            <div class="money-preview {% if money_type == 'receive' %}money-preview--receive{% else %}money-preview--give{% endif %}">
              <div class="money-preview-label">
                {% if money_type == 'receive' %}
                You will receive
                {% else %}
                You will give
                {% endif %}
              </div>
              <div class="money-preview-amount">€{{ money_amount }}</div>
              <div class="money-preview-suffix">as part of this deal</div>
            </div>
          </div>
        </div>
        {% endif %}

        <!-- Status Note -->
        <div class="notice">
          <p>
            <strong>Waiting for response:</strong> This offer has been sent and is awaiting {{ proposal.to_company.name }}'s decision. You cannot make changes at this time.
          </p>
        </div>
      </div>
    </main>
  </div>
{% endblock %}
